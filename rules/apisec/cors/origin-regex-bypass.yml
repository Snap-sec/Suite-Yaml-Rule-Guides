rule_name: CORS Origin Regex Bypass
description: Detects if the application uses a weak regex to validate the Origin header (e.g. matching 'domain.com' anywhere in the string).
transform:
  headers:
    replace:
      Origin: "https://snapsec.evil.com" 
match_on:
  status: 200
  headers:
    Access-Control-Allow-Origin: 
      regex: ".*\\.evil\\.com"
    Access-Control-Allow-Credentials: "true"
report:
  title: "CORS: Weak Regex Origin Validation"
  description: |
    The application appears to allow an origin ending in '.evil.com', suggesting it matches the authorized domain loosely (e.g. via weak regex).
    
    We attempted sending: {{req.headers.Origin}}
    The server reflected: {{res.headers.Access-Control-Allow-Origin}}

    Original Request:
    {{original}}

    Transformed Request:
    {{req}}

    Response:
    {{res}}

  cwe: "CWE-942"
  cvssScore: "7.5"
  mitigation: |
    1. Use exact string matching for origins.
    2. If using regex, anchor start (^) and end ($) and escape dots (\.).
  stepsToReproduce: |
    1. Send request with 'Origin: https://snapsec.evil.com'
    2. Observe reflection of the malicious origin with credentials.
  tags: "cors,bypass,high"
  impact: "Bypass of CORS whitelist"
